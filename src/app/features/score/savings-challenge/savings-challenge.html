<div class="savings-page">
  <div class="savings-header">
    <div>
      <h1 class="savings-title">{{ pageTitle }}</h1>
      <p class="savings-subtitle">{{ pageSubtitle }}</p>
    </div>
    <a [routerLink]="backRoute" class="savings-back">{{ backLabel }}</a>
  </div>

  <div *ngIf="loading" class="savings-loading">
    <span class="material-symbols-outlined savings-spinner">progress_activity</span>
    <p>Loading…</p>
  </div>

  <div *ngIf="!loading && error" class="savings-error">
    <span class="material-symbols-outlined">error</span>
    <p>{{ error }}</p>
  </div>

  <ng-container *ngIf="!loading && !error">
    <!-- Not enrolled: list challenges -->
    <div *ngIf="!enrollment" class="savings-not-enrolled">
      <h2 class="savings-section-title">{{ notEnrolledTitle }}</h2>
      <p class="savings-section-subtitle">{{ notEnrolledSubtitle }}</p>
      <div class="savings-challenge-cards">
        <div *ngFor="let ch of challenges" class="savings-challenge-card">
          <div class="savings-challenge-card-inner">
            <p class="savings-challenge-name">{{ ch.name }}</p>
            <p class="savings-challenge-detail">{{ ch.amountTnd }} TND every {{ ch.periodMonths }} months · +{{ ch.pointsPerPeriod }} pts per period</p>
            <button type="button" class="savings-btn-join" [disabled]="loadingAction" (click)="joinChallenge(ch)">
              <span class="material-symbols-outlined">add</span>
              {{ joinLabel }}
            </button>
          </div>
        </div>
      </div>
      <p *ngIf="challenges.length === 0" class="savings-empty">No challenges available right now.</p>
    </div>

    <!-- Enrolled: commitment, progress, pay, withdraw, history -->
    <div *ngIf="enrollment" class="savings-enrolled">
      <div class="savings-hero">
        <p class="savings-hero-label">Your commitment</p>
        <h2 class="savings-hero-amount">{{ commitmentAmount }} <span class="savings-hero-unit">{{ commitmentUnit }}</span></h2>
        <p class="savings-hero-note">{{ commitmentNote }}</p>
        <div class="savings-progress-wrap">
          <div class="savings-progress-bar">
            <div class="savings-progress-fill" [style.width.%]="progressPercent"></div>
          </div>
          <span class="savings-progress-text">{{ progressText }}</span>
        </div>
      </div>

      <div class="savings-cards">
        <div class="savings-card">
          <p class="savings-card-label">Total saved (challenge)</p>
          <p class="savings-card-value">{{ totalSavedAmount }}</p>
          <p class="savings-card-note">Can be used as down payment for credit</p>
        </div>
        <div class="savings-card">
          <p class="savings-card-label">Points earned (savings)</p>
          <p class="savings-card-value savings-card-value-pts">{{ pointsEarnedAmount }}</p>
          <p class="savings-card-note">{{ pointsNote }}</p>
        </div>
      </div>

      <div class="savings-actions">
        <button type="button" class="savings-btn-pay" [disabled]="loadingAction" (click)="payPeriod()">
          <span class="material-symbols-outlined">savings</span>
          {{ payPeriodLabel }}
        </button>
        <button *ngIf="canWithdraw" type="button" class="savings-btn-withdraw" [disabled]="loadingAction" (click)="withdraw()">
          <span class="material-symbols-outlined">account_balance_wallet</span>
          {{ withdrawLabel }}
        </button>
      </div>
      <p class="savings-no-penalty">{{ noPenaltyNote }}</p>

      <div class="savings-history-card">
        <h4 class="savings-history-title">
          <span class="material-symbols-outlined">calendar_month</span>
          {{ monthlyHistoryTitle }}
        </h4>
        <div class="savings-history-list">
          <div *ngFor="let row of monthlyHistory" class="savings-history-row">
            <div class="savings-history-icon">
              <span class="material-symbols-outlined">check_circle</span>
            </div>
            <div class="savings-history-text">
              <p class="savings-history-month">{{ row.month }}</p>
              <p class="savings-history-detail">{{ row.detail }}</p>
            </div>
            <span class="savings-history-status" [ngClass]="row.statusClass">{{ row.statusLabel }}</span>
          </div>
        </div>
        <p *ngIf="monthlyHistory.length === 0" class="savings-history-empty">No periods paid yet. Use “{{ payPeriodLabel }}” when ready.</p>
      </div>

      <div class="savings-tip">
        <p><strong>Tip:</strong> {{ tipText }}</p>
      </div>
    </div>
  </ng-container>

  <!-- Pay error modal (e.g. insufficient balance) -->
  <div *ngIf="showPayModal" class="savings-modal-overlay" (click)="closePayModal()">
    <div class="savings-modal" (click)="$event.stopPropagation()">
      <div class="savings-modal-icon">
        <span class="material-symbols-outlined">account_balance_wallet</span>
      </div>
      <h3 class="savings-modal-title">Couldn’t complete payment</h3>
      <p class="savings-modal-message">{{ payModalMessage }}</p>
      <button type="button" class="savings-modal-btn" (click)="closePayModal()">OK</button>
    </div>
  </div>
</div>
