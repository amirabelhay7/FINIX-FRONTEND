<div class="tutorials-page">
  <header class="tutorials-header">
    <div class="tutorials-header-inner">
      <span class="tutorials-header-icon material-symbols-outlined">school</span>
      <div>
        <h1 class="tutorials-title">Tutorials</h1>
        <p class="tutorials-subtitle">Learn how your FINIX score works and earn points. Quizzes included.</p>
      </div>
    </div>
  </header>

  <div *ngIf="loading" class="tutorials-loading">
    <span class="material-symbols-outlined spin">progress_activity</span>
    <p>Loading tutorials…</p>
  </div>

  <div *ngIf="!loading && error" class="tutorials-error">
    <span class="material-symbols-outlined">error</span>
    <p>{{ error }}</p>
    <button type="button" class="btn-retry" (click)="loadTutorials()">Retry</button>
  </div>

  <ng-container *ngIf="!loading && !error">
    <div *ngIf="showNotFoundMessage" class="tutorials-not-found">
      <span class="material-symbols-outlined">info</span>
      <p>Tutorial not found or no longer available. Pick one below.</p>
    </div>
    <div class="tutorials-toolbar">
      <div class="tutorials-filters">
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <select class="filter-select" [value]="selectedCategory" (change)="selectCategory($any($event).target.value)">
            <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Difficulty</label>
          <select class="filter-select" [value]="selectedDifficulty" (change)="selectDifficulty($any($event).target.value)">
            <option *ngFor="let difficulty of difficulties" [value]="difficulty">{{ difficulty }}</option>
          </select>
        </div>
      </div>
      <p class="tutorials-count">{{ getFilteredTutorials().length }} tutorial<span *ngIf="getFilteredTutorials().length !== 1">s</span></p>
    </div>

    <div class="tutorials-grid">
      <article *ngFor="let tutorial of getFilteredTutorials()" 
               class="tutorial-card" 
               [attr.data-type]="(tutorial.tutorialType || '').toLowerCase()"
               [class.is-completed]="tutorial.status === 'COMPLETED'"
               [class.is-locked]="tutorial.status === 'LOCKED'">
        <div class="tutorial-card-inner" (click)="tutorial.status !== 'LOCKED' && (tutorial.status === 'COMPLETED' ? viewTutorialDetail(tutorial) : startTutorial(tutorial))">
          <div class="tutorial-card-top">
            <span class="tutorial-card-status" [attr.data-status]="tutorial.status">
              <span *ngIf="tutorial.status === 'COMPLETED'">Done</span>
              <span *ngIf="tutorial.status === 'IN_PROGRESS'">In progress</span>
              <span *ngIf="tutorial.status === 'NOT_STARTED'">Not started</span>
              <span *ngIf="tutorial.status === 'LOCKED'">Locked</span>
            </span>
            <div class="tutorial-card-icon-wrap">
              <span class="material-symbols-outlined tutorial-card-icon">{{ tutorial.icon }}</span>
            </div>
          </div>
          <h3 class="tutorial-card-title">{{ tutorial.title }}</h3>
          <p class="tutorial-card-desc">{{ ((tutorial.description || '').slice(0, 100)) + ((tutorial.description || '').length > 100 ? '…' : '') }}</p>
          <div class="tutorial-card-meta">
            <span class="tutorial-card-difficulty">{{ tutorial.difficulty }}</span>
            <span class="tutorial-card-time">
              <span class="material-symbols-outlined">schedule</span>
              {{ tutorial.estimatedMinutes }} min
            </span>
            <span class="tutorial-card-points">+{{ tutorial.pointsAwarded }} pts</span>
          </div>

          <div *ngIf="tutorial.status === 'IN_PROGRESS'" class="tutorial-card-progress">
            <div class="tutorial-card-progress-bar">
              <div class="tutorial-card-progress-fill" [style.width.%]="tutorial.progress ?? 0"></div>
            </div>
            <span class="tutorial-card-progress-text">{{ tutorial.progress ?? 0 }}%</span>
          </div>

          <div class="tutorial-card-actions">
            <button type="button" 
                    class="btn-card btn-primary" 
                    (click)="$event.stopPropagation(); tutorial.status === 'COMPLETED' ? viewTutorialDetail(tutorial) : startTutorial(tutorial)"
                    [disabled]="tutorial.status === 'LOCKED'">
              <span class="material-symbols-outlined">
                {{ tutorial.status === 'COMPLETED' ? 'replay' : tutorial.status === 'IN_PROGRESS' ? 'play_arrow' : 'play_circle' }}
              </span>
              <span *ngIf="tutorial.status === 'NOT_STARTED'">Start</span>
              <span *ngIf="tutorial.status === 'IN_PROGRESS'">Continue</span>
              <span *ngIf="tutorial.status === 'COMPLETED'">Review</span>
              <span *ngIf="tutorial.status === 'LOCKED'">Locked</span>
            </button>
            <button *ngIf="tutorial.status === 'IN_PROGRESS'" 
                    type="button" 
                    class="btn-card btn-complete" 
                    (click)="$event.stopPropagation(); completeTutorial(tutorial, $event)">
              <span class="material-symbols-outlined">check_circle</span>
              Complete
            </button>
          </div>
        </div>
      </article>
    </div>

    <div *ngIf="getFilteredTutorials().length === 0" class="tutorials-empty">
      <span class="material-symbols-outlined tutorials-empty-icon">folder_off</span>
      <h3 class="tutorials-empty-title">No tutorials match</h3>
      <p class="tutorials-empty-text">Try changing the filters above.</p>
    </div>
  </ng-container>
</div>
